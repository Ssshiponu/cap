{% extends "dashboard.html" %}
{% load static %}
{% block content %}


    <div x-data="steps()" class="flex flex-col h-[calc(100vh-56px)] w-full relative">
        <!-- Step content area with proper scrolling -->
        <div class="flex-1 h-full w-full">
            <div class="steps markdown p-8 md:p-12 !pb-32 max-w-3xl h-full overflow-y-auto scrollbar-invisible">
                <div x-show="step === 1" class="step">
                    <h2 class="mt-0">1. Start Set up</h2>
                    <ol>
                        <li>
                            Go to
                            <a href="https://developer.facebook.com/">developer.facebook.com</a>.
                        </li>
                        <li>Click <strong>My Apps</strong> → <strong>Create App</strong>.</li>
                        <li>
                            Fill in:
                            <ul>
                                <li><strong>App name</strong></li>
                                <li><strong>Contact email</strong></li>
                            </ul>
                        </li>
                        <li>
                            Select: Use case - <strong>Other</strong>
                        </li>
                        <li>
                            Select: Type -<strong>Business</strong>
                        </li>
                        <li>Click <strong>Create App</strong>.</li>
                    </ol>
                </div>

                <div x-show="step === 2" class="step">
                    <h2 id="2-set-up-webhook-url">2. SetUp Webhook URL</h2>
                    <p>Messenger uses a webhook to send you messages from your page.</p>
                    <ol>
                        <li>
                            Inside your app dashboard, click <strong>Set Up</strong> under
                            <strong>Messenger</strong>.
                        </li>
                        <li>
                            <p>Enter:</p>
                            <ul>
                                <li>
                                    <p><strong>Callback URL</strong>:</p>
                                    <div x-data="{ copied: false, url: '{{ webhook_url }}' }" class="relative items-center">
                                        <input type="text" class="input w-full pr-10" :value="url" readonly>
                                        <button @click="navigator.clipboard.writeText(url); copied = true; setTimeout(() => copied = false, 2000);" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1 focus:outline-none rounded bg-white hover:bg-neutral-100" :class="copied ? 'text-green-500' : 'text-neutral-700'">
                                            <svg x-show="!copied" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                            <svg x-show="copied" xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="text-green-500"  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-check-icon lucide-copy-check"><path d="m12 15 2 2 4-4"/><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                        </button>
                                    </div>
                                </li>
                                <li>
                                    <p><strong>Verify Token</strong>:</p>
                                    <div x-data="{ copied: false, token: '{{ verify_token }}' }" class="relative items-center">
                                        <input type="password" class="input w-full pr-10" :value="token" readonly>
                                        <button @click="navigator.clipboard.writeText(token); copied = true; setTimeout(() => copied = false, 2000);" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1 focus:outline-none rounded bg-white hover:bg-neutral-100" :class="copied ? 'text-green-500' : 'text-neutral-700'">
                                            <svg x-show="!copied" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                            <svg x-show="copied" xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="text-green-500"  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-check-icon lucide-copy-check"><path d="m12 15 2 2 4-4"/><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                        </button>
                                    </div>
                                </li>
                            </ul>
                        </li>
                        <li>Click <strong>Verify and Save</strong>.</li>
                    </ol>
                </div>

                <div x-show="step === 3" class="step">
                    <h2 id="3-generate-page-access-token">3. Generate Page Access Token</h2>
                    <p>To reply to messages, you need a <strong>Page Access Token</strong>.</p>
                    <ol>
                        <li>Click <strong>Connect</strong>.</li>
                        <li>Continue as your Facebook account.</li>
                        <li>Select the <strong>Page</strong> you want to connect.</li>
                        <li>Continue and confirm.</li>
                        <li>
                            <p>Under <strong>Subscriptions</strong>, check:</p>
                            <ul>
                                <li><code>messages</code></li>
                                <li><code>messaging_postback</code></li>
                            </ul>
                        </li>
                        <li>Confirm your choices.</li>
                        <li>
                            Go to <strong>Token</strong> → <strong>Generate</strong>. Copy the
                            generated token and pest it below.
                            
                        </li>
                        <li>Now go to <strong>Settings</strong> → <strong>Basic</strong> and copy paste the App Secret below.</li>
                    </ol>
                    <form action="" method="post" class="mt-4 flex flex-col items-end gap-4">
                        {% csrf_token %}
                        <input type="hidden" name="app_id" value="{{ request.GET.app_id }}">
                        <div class="space-y-1 w-full">
                            <label for="page_access_token" class="text-sm font-medium">Page Access Token</label>
                            <input id="page_access_token" {% if is_configured %} :placeholder="'•'.repeat(100)" {% endif %} type="password"  name="page_access_token" class="input w-full" required>
                        </div>
                        <div class="space-y-1 w-full">
                            <label for="app_secret" class="text-sm font-medium">App Secret</label>
                            <input id="app_secret" {% if is_configured %}  :placeholder="'•'.repeat(32)" {% endif %} type="password" name="app_secret" class="input w-full" required>
                        </div>
                        <button type="submit" class="btn pl-2 btn-primary flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="text-white w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save-all-icon lucide-save-all"><path d="M10 2v3a1 1 0 0 0 1 1h5"/><path d="M18 18v-6a1 1 0 0 0-1-1h-6a1 1 0 0 0-1 1v6"/><path d="M18 22H4a2 2 0 0 1-2-2V6"/><path d="M8 18a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9.172a2 2 0 0 1 1.414.586l2.828 2.828A2 2 0 0 1 22 6.828V16a2 2 0 0 1-2.01 2z"/></svg>
                            {% if is_configured %}Update{% else %}Save tokens{% endif %}
                        </button>
                    </form>
                </div>

                <div x-show="step === 4" class="step">
                    <h2 id="4-test-the-connection">4. Test the Connection</h2>
                    <ol>
                        <li>Send a message from the Facebook account you connected earlier.</li>
                        <li>Your server should receive the message and send an automatic reply.</li>
                    </ol>
                    <p>
                        ⚠️ At this stage, it will <strong>only work with your own account</strong>.
                        To enable it for all users, continue to the next step.
                    </p>
                </div>

                <div x-show="step === 5" class="step">
                    <h2 id="5-make-the-app-live">5. Make the App Live</h2>
                    <p>To allow messages from any user, you must make the app public.</p>
                    <ol>
                        <li>
                            Prepare a <strong>Privacy Policy URL</strong> (this can be a simple page
                            explaining how you handle data).
                        </li>
                        <li>In the app dashboard, go to <strong>App Settings → Basic</strong>.</li>
                        <li>
                            Paste your privacy policy URL into the
                            <strong>Privacy Policy URL</strong> field.
                        </li>
                        <li>Click <strong>Save Changes</strong>.</li>
                        <li>
                            Toggle the <strong>App Mode</strong> switch to <strong>Live</strong>.
                        </li>
                    </ol>
                    <p>
                        Now your Messenger bot is live and will respond to messages from all users.
                    </p>
                </div>

                <div x-show="step === 6" class="step">
                    <h2 id="6-finish">6. Finish</h2>
                    <p>✅ Done! Your Messenger app is now connected and live.</p>
                    <h3 id="notes-tips">Notes &amp; Tips</h3>
                    <ul>
                        <li>
                            Keep your <strong>Verify Token</strong> and
                            <strong>Page Access Token</strong> secret.
                        </li>
                        <li>Tokens may expire; regenerate them if your bot stops responding.</li>
                        <li>Always test with multiple accounts after going live.</li>
                        <li>
                            Facebook requires apps to follow its
                            <a href="https://developers.facebook.com/policy/">Platform Policies</a>.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Fixed footer navigation -->
        <div class="absolute bottom-0 left-0 right-0 flex-shrink-0 flex items-center justify-between gap-3 p-4 border-t-2 border-neutral-200 bg-white">
            <div class="flex items-center gap-2 text-sm text-gray-600">
                <span>Step</span>
                <span x-text="step" class="font-semibold"></span>
                <span>of</span>
                <span x-text="maxStep" class="font-semibold"></span>
            </div>
            <div class="flex gap-2">
                <button @click="backStep()" :disabled="step === 1" class="btn" :class="step === 1 ? 'opacity-50 cursor-not-allowed' : ''">Back</button>
                <button @click="nextStep()" class="btn btn-primary">
                    <span x-text="nextStepText()"></span>
                </button>
            </div>
        </div>
    </div>
{% endblock content %}